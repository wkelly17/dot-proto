---
import Layout from "../layouts/Layout.astro";
import type { IVidWithCustom } from "@customTypes/types";


import {
  convertToValidFilename,
  formatDuration,
  getMp4DownloadSize,
  groupObjectsByKey,
} from "../utils";
import {Vid2} from "../components/VidTest2";
import {PlayerModuleImporter} from "../components/PlayerParent";
import { Header } from "@components/Header";
import { playbackApi } from "src/customTypes/Api";
import { VidPlayer } from "@components/VidPlayer";


const policyKey =
  "BCpkADawqM0bQiUyoSejARSlmKAaReqHw7sRy-4OFGmD8lb2ibVNF-d7H4wtYWIS8NMHOP-3IrfH1mVnUzhxQThtzvPBe-IUyk9EagJcJwWrbIBBCg1tsi8vJFv7_S6GGiTNhDwXFJfwF_W-";
const pbApi = new playbackApi({
  baseUrl: "https://edge.api.brightcove.com/playback/v1",
  baseApiParams: {
    // headers: [['Accept', `application/json;pk=${policyKey}`]]
    headers: {
      "Accept": `application/json;pk=${policyKey}`
    }
  }
})
const playbackBaseUrl = "https://edge.api.brightcove.com/playback/v1";
const accountId = "6314154063001";
const playListId = "1745043212224883810";
const {playlist} = Astro.params;
let data; 
try {
  const res = await pbApi.accounts.getPlaylistsByIdOrReferenceId(accountId, `ref:will-test`, {
    limit: 400, 
  })

  if (res.ok) {
    data = res.data
  } else {
    return new Response(404)
  }
} catch (error) {
  // console.error(error)
  return new Response(404)
}
// type coercion here to add a few extra types below on this vids array. 
const vids = data.videos as IVidWithCustom[]
if (!vids || !vids.length) {
  console.log("no vids")
  return new Response(404)
}

 const pattern =
    /^.*?(\d{2})-(?:\d)?[A-Z]{2,3}_(\d?.+?)_([0-9]{2,3})(?:\..+)?$/;
type accType = {
  matching: IVidWithCustom[],
  notMatching: IVidWithCustom[]
}
const filteredByMatchingReferenceId = vids.reduce((accumulator: accType, current) => {  
  if (pattern.test(String(current.reference_id))) {
    accumulator.matching.push(current);
  } else {
    accumulator.notMatching.push(current);
  }
  return accumulator;
}, {
  matching: [],
  notMatching: []
});
const sortedVids = filteredByMatchingReferenceId.matching.sort((a, b) =>  {
  // Given this pattern: ASE-X-BENINSL_63-1JN_1Jean_01.mp4
  // match 0 is entire string
  // match 1 is the sort order, 63 ((?:\d)
  // match 2 is the book (1Jean)
  // match 3 is the chapter.
  // optional extension on the end.
  


  // /^.*?(\d{2})-(?:0|1)?[A-Z]{2,3}_\d?(.+?)_([0-9]{2,3})(?:\..+)?$/;
  const ref1 = a.reference_id?.toUpperCase();
  const ref2 = b.reference_id?.toUpperCase();
  if (!ref1 || !ref2)  return 0
  const match = ref1.match(pattern);
  const match2 = ref2.match(pattern);
  if (!match || !match2) {
    console.log("NO MATCH", ref1, ref2)
    return -1;
  }
  const sortA = Number(match[1]);
  const bookA = match[2];
  const chapterNumberA = Number(match[3]);
  const sortB = Number(match2[1]);
  const bookB = match2[2];
  const chapterNumberB = Number(match2[3]);
  a.book = a.book?.normalize() || bookA.normalize()
  b.book = b.book?.normalize() || bookB.normalize()
  a.chapNum = chapterNumberA
  b.chapNum = chapterNumberB

  let retVal;
  if (sortA == sortB) {
    retVal =
      chapterNumberA < chapterNumberB
        ? -1
        : chapterNumberA == chapterNumberB
        ? 0
        : 1;
  } else {
    retVal = sortA < sortB ? -1 : sortA == sortB ? 0 : 1;
  }

  // console.log({
  //   ref1,
  //   ref2,
  //   sortA,
  //   sortB,
  //   chapterNumberA,
  //   chapterNumberB,
  //   retVal,
  // });
  return retVal;
});

sortedVids.forEach((vid, idx) => {
  vid.originalIdx = idx;
  vid.slugName = convertToValidFilename(String(vid.name));
  // console.log(vid.book , vid.chapNum)
});

const book = Astro.url.searchParams.get('book')
const chapter = Astro.url.searchParams.get('chapter')
const bucketized = groupObjectsByKey<IVidWithCustom, "book">(sortedVids, "book");
bucketized.other = filteredByMatchingReferenceId.notMatching
const defaultVid =
      bucketized[String(book).toUpperCase()] ||
      bucketized[Object.keys(bucketized)[0]];
    const defaultChap = defaultVid[0];
    console.log(defaultChap.id)
// console.log({bucketized})
---

<Layout title="Experiments">
	<div class="grid grid-rows-[auto_1fr] h-screen sm:(h-auto)">
		<Header/>
		<h1 class="text-3xl text-center">Quality Experiments</h1>
  <div
    class="grid grid-rows-[auto_auto_1fr] overflow-y-auto"
  
  >

    <PlayerModuleImporter client:only="solid-js">
      <VidPlayer vids={bucketized} book={book} chapter={chapter} playlist={playlist} client:load/>

    </PlayerModuleImporter>
  </div>
</div>
</Layout>


<!-- <script define:vars={{ myPlayerUrl }} is:inline src={myPlayerUrl}></script> -->
